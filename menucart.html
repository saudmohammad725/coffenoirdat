<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="utf-8">
    <title>سلة المشروبات - Noir Café</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="Menu Cart Page" name="keywords">
    <meta content="Menu Cart Page" name="description">

    <!-- Sentry Error Monitoring -->
    <script
      src="https://js.sentry-cdn.com/05aba6f8208a887ef8880e277cee0c6e.min.js"
      crossorigin="anonymous"
    ></script>
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBlGaghNVTvLXiykCaIrTszEVuHd5TG4U",
            authDomain: "coffeenoir-1fe6b.firebaseapp.com",
            projectId: "coffeenoir-1fe6b",
            storageBucket: "coffeenoir-1fe6b.firebasestorage.app",
            messagingSenderId: "846057487909",
            appId: "1:846057487909:web:37490e1ef5d53ebc4989cc",
            measurementId: "G-4XB0L1T0XM"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <link href="img/favicon.ico" rel="icon">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <link href="css/style.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Tajawal', 'Roboto', 'Montserrat', sans-serif; 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 25%, #ffffff 50%, #f1f3f4 75%, #ffffff 100%) !important;
            background-size: 400% 400% !important;
            animation: gradientMove 8s ease-in-out infinite !important;
            position: relative !important;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 30%, rgba(218,159,91,0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(51,33,29,0.05) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(218,159,91,0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .payment-container {
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .cart-summary {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .cart-summary h3, .cart-summary h4 {
            color: #33211D !important;
            font-weight: bold;
            text-shadow: none;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item:hover {
            background: rgba(218,159,91,0.05);
            border-radius: 8px;
            padding: 20px 15px;
        }
        
        .item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .remove-item {
            background: #dc3545;
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .remove-item:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .item-info {
            display: flex;
            align-items: center;
        }
        
        .item-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            background-size: cover;
            background-position: center;
            border: 3px solid #DA9F5B;
        }
        
        .total-section {
            background: linear-gradient(135deg, #33211D, #4a302a);
            color: white !important;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .total-section h4,
        .total-section h3 {
            color: white !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .payment-methods {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .payment-methods h3 {
            color: #33211D !important;
            font-weight: bold;
        }
        
        .pay-button {
            background: linear-gradient(135deg, #DA9F5B, #f4c088);
            border: none;
            color: #33211D;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .pay-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(218,159,91,0.4);
            color: #33211D;
        }
        
        .pay-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .back-button {
            background: linear-gradient(135deg, #DA9F5B, #f4c088);
            border: none;
            color: white !important;
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(218,159,91,0.3);
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(218,159,91,0.5);
            color: white !important;
            text-decoration: none;
            background: linear-gradient(135deg, #f4c088, #DA9F5B);
        }
        
        .back-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(218,159,91,0.25);
        }
        
        .points-payment {
            background: linear-gradient(135deg, rgba(218,159,91,0.1), rgba(244,192,136,0.1));
            border: 2px solid #DA9F5B;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .points-balance {
            font-size: 24px;
            font-weight: bold;
            color: #DA9F5B;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            display: none;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #DA9F5B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            display: none;
        }
        
        .success-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            animation: successBounce 0.6s ease;
        }
        
        @keyframes successBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 35px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h4>جاري الدفع بالنقاط...</h4>
            <p>يرجى الانتظار قليلاً</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">
                <i class="fa fa-check"></i>
            </div>
            <h3 style="color: #28a745; margin-bottom: 15px;">تم الدفع بنجاح!</h3>
            <p style="margin-bottom: 25px;">تم شراء المنتجات بنجاح</p>
            <button class="btn btn-success btn-lg" onclick="goToMenu()">
                <i class="fa fa-utensils mr-2"></i>
                العودة إلى القائمة
            </button>
        </div>
    </div>

    <!-- Navbar Start -->
    <div class="container-fluid p-0 nav-bar">
        <nav class="navbar navbar-expand-lg bg-none navbar-dark py-3">
            <a href="index.html" class="navbar-brand px-lg-4 m-0">
                <h2 class="m-0 text-uppercase text-white font-weight-bold" style="font-size: 2rem;">Noir Café</h2>
            </a>
            <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
                <div class="navbar-nav ml-auto p-4">
                    <a href="index.html" class="nav-item nav-link">الرئيسية</a>
                    <a href="about.html" class="nav-item nav-link">من نحن</a>
                    <a href="service.html" class="nav-item nav-link">الخدمات</a>
                    <a href="menu.html" class="nav-item nav-link">القائمة</a>
                    <a href="profile.html" class="nav-item nav-link">الملف الشخصي</a>
                    <a href="contact.html" class="nav-item nav-link">تواصل معنا</a>
                    
                    <!-- User Points Display in Navbar -->
                    <div class="nav-item d-flex align-items-center mr-3" style="background: linear-gradient(135deg, rgba(218,159,91,0.2), rgba(51,33,29,0.1)); border-radius: 20px; padding: 6px 12px; border: 1px solid rgba(218,159,91,0.3); cursor: pointer;" onclick="window.location.href='points.html'" title="رصيد النقاط - اضغط للشراء">
                        <i class="fa fa-coins mr-3" style="color: #DA9F5B;"></i>
                        <span class="text-white font-weight-bold" id="navUserPointsDisplay">0</span>
                    </div>
                </div>
            </div>
        </nav>
    </div>
    <!-- Navbar End -->

    <!-- Page Header Start -->
    <div class="container-fluid page-header mb-5 position-relative overlay-bottom">
        <div class="d-flex flex-column align-items-center justify-content-center pt-0 pt-lg-5" style="min-height: 400px">
            <h1 class="display-4 mb-3 mt-0 mt-lg-5 text-white text-uppercase">سلة المشروبات</h1>
            <div class="d-inline-flex mb-lg-5">
                <p class="m-0 text-white"><a class="text-white" href="index.html">الرئيسية</a></p>
                <p class="m-0 text-white px-2">/</p>
                <p class="m-0 text-white"><a class="text-white" href="menu.html">القائمة</a></p>
                <p class="m-0 text-white px-2">/</p>
                <p class="m-0 text-white">السلة</p>
            </div>
        </div>
    </div>
    <!-- Page Header End -->

    <div class="payment-container">
        <button type="button" class="back-button" onclick="goBackToMenu()">
            <i class="fa fa-arrow-right mr-2"></i>
            العودة إلى القائمة
        </button>

        <div class="row">
            <!-- Cart Summary -->
            <div class="col-lg-8">
                <div class="cart-summary">
                    <h3 class="mb-4">
                        <i class="fa fa-shopping-cart text-primary mr-2"></i>
                        المنتجات المختارة
                    </h3>
                    <div id="cartItems">
                        <!-- Cart items will be loaded here -->
                    </div>
                    <div class="total-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>المجموع الكلي:</h4>
                            <h3 id="totalAmount">0 نقطة</h3>
                        </div>
                    </div>
                </div>

                <!-- Points Payment -->
                <div class="points-payment">
                    <h3 class="mb-4">
                        <i class="fa fa-coins text-primary mr-2"></i>
                        الدفع بالنقاط
                    </h3>
                    
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-wallet mr-3" style="color: #DA9F5B; font-size: 24px;"></i>
                                <div>
                                    <p class="mb-1 font-weight-bold">رصيدك الحالي:</p>
                                    <span class="points-balance" id="currentPoints">0</span>
                                    <small class="text-muted"> نقطة</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 text-right">
                            <div id="balanceStatus" class="font-weight-bold"></div>
                        </div>
                    </div>

                    <button class="pay-button" id="payButton" onclick="processPayment()" disabled>
                        <i class="fa fa-credit-card mr-2"></i>
                        ادفع بالنقاط الآن
                    </button>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h4 class="mb-3">تفاصيل الطلب</h4>
                    <div class="d-flex justify-content-between mb-2">
                        <span>عدد المنتجات:</span>
                        <span id="itemCount">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>التكلفة الإجمالية:</span>
                        <span id="totalPoints">0 نقطة</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>المطلوب دفعه:</strong>
                        <strong id="finalTotal">0 نقطة</strong>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle mr-2"></i>
                        <small>سيتم خصم النقاط من رصيدك فور إتمام الدفع</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <script>
        let cartItems = [];
        let currentUserPoints = 0;

        $(document).ready(function() {
            loadCartItems();
            loadUserPoints();
            updateNavPointsDisplay();
        });

        // Load cart items from localStorage
        function loadCartItems() {
            const savedItems = localStorage.getItem('menuCartItems');
            const savedCount = localStorage.getItem('menuCartCount');

            if (savedItems && savedCount) {
                cartItems = JSON.parse(savedItems);
                displayCartItems();
                updateTotals();
            } else {
                // Redirect to menu page if cart is empty
                window.location.href = 'menu.html';
            }
        }
        
        // Load user points
        function loadUserPoints() {
            if (window.pointsManager) {
                currentUserPoints = window.pointsManager.getPoints();
            } else {
                currentUserPoints = parseInt(localStorage.getItem('userPoints') || '0');
            }
            document.getElementById('currentPoints').textContent = currentUserPoints;
            checkBalance();
        }

        // Display cart items
        function displayCartItems() {
            const container = document.getElementById('cartItems');
            let html = '';

            cartItems.forEach((item, index) => {
                html += `
                    <div class="cart-item" data-index="${index}">
                        <div class="item-info">
                            <div class="item-icon" style="background-image: url('${item.image}')"></div>
                            <div>
                                <h5>${item.name}</h5>
                                <p class="text-muted mb-0">مشروب من القائمة</p>
                            </div>
                        </div>
                        <div class="item-actions">
                            <div class="item-price">
                                <h5>${item.price} نقطة</h5>
                            </div>
                            <button class="remove-item" onclick="removeFromCart(${index})" title="حذف المنتج">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        // Remove item from cart
        function removeFromCart(index) {
            if (index >= 0 && index < cartItems.length) {
                cartItems.splice(index, 1);
                
                // Update localStorage
                localStorage.setItem('menuCartItems', JSON.stringify(cartItems));
                localStorage.setItem('menuCartCount', cartItems.length);
                
                // Refresh display
                displayCartItems();
                updateTotals();
                checkBalance();
                
                // If cart is empty, redirect to menu page
                if (cartItems.length === 0) {
                    setTimeout(() => {
                        window.location.href = 'menu.html';
                    }, 1000);
                }
            }
        }

        // Update totals
        function updateTotals() {
            let total = 0;

            cartItems.forEach(item => {
                total += item.price;
            });

            document.getElementById('totalAmount').textContent = total + ' نقطة';
            document.getElementById('itemCount').textContent = cartItems.length;
            document.getElementById('totalPoints').textContent = total + ' نقطة';
            document.getElementById('finalTotal').textContent = total + ' نقطة';
        }
        
        // Check if user has enough points
        function checkBalance() {
            let total = 0;
            cartItems.forEach(item => {
                total += item.price;
            });
            
            const payButton = document.getElementById('payButton');
            const balanceStatus = document.getElementById('balanceStatus');
            
            if (currentUserPoints >= total) {
                payButton.disabled = false;
                balanceStatus.innerHTML = '<span style="color: #28a745;"><i class="fa fa-check-circle mr-1"></i>رصيدك كافي للدفع</span>';
            } else {
                payButton.disabled = true;
                const needed = total - currentUserPoints;
                balanceStatus.innerHTML = `<span style="color: #dc3545;"><i class="fa fa-exclamation-circle mr-1"></i>تحتاج ${needed} نقطة إضافية</span>`;
            }
        }

        // Process payment
        function processPayment() {
            // Show loading overlay
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Simulate payment processing
            setTimeout(() => {
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Process successful payment
                completePayment();
            }, 2000);
        }

        // Complete payment
        function completePayment() {
            // Calculate total cost
            let totalCost = 0;
            
            cartItems.forEach(item => {
                totalCost += item.price;
            });

            // Create transaction record
            const transaction = {
                id: 'MENU_TXN_' + Date.now(),
                items: cartItems,
                totalCost: totalCost,
                paymentMethod: 'points',
                timestamp: new Date().toISOString(),
                status: 'completed',
                type: 'menu'
            };

            // Save transaction to localStorage
            const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            // Deduct points from user's balance using points manager
            if (window.pointsManager) {
                const success = window.pointsManager.deductPoints(totalCost);
                if (!success) {
                    alert('نقاطك غير كافية لإتمام هذا الطلب. يرجى شراء المزيد من النقاط.');
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }
            } else {
                // Fallback method
                const newPoints = currentUserPoints - totalCost;
                localStorage.setItem('userPoints', newPoints);
            }

            // Clear cart
            localStorage.removeItem('menuCartItems');
            localStorage.removeItem('menuCartCount');

            // Show success modal
            document.getElementById('successModal').style.display = 'flex';
        }

        // Go to menu
        function goToMenu() {
            window.location.href = 'menu.html';
        }
        
        // Go back to menu page
        function goBackToMenu() {
            window.location.href = 'menu.html';
        }
        
        // Update navbar points display
        function updateNavPointsDisplay() {
            if (window.pointsManager) {
                window.pointsManager.updateAllDisplays();
            }
        }
    </script>

    <!-- Points Manager -->
    <script src="js/points-manager.js"></script>
    
    <script src="js/main.js"></script>
</body>

</html>
