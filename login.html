<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8">
    <title>Noir Café - تسجيل الدخول</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="تسجيل الدخول - Noir Café" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.min.css" rel="stylesheet">
    
    <!-- Firebase v8 SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>

    <style>
        body { font-family: 'Tajawal', 'Roboto', 'Montserrat', sans-serif; }
        
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(218,159,91,0.1), rgba(51,33,29,0.05));
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            max-width: 450px;
            width: 100%;
        }
        
        .auth-header {
            background: linear-gradient(135deg, #DA9F5B, #c8935a);
            color: #fff;
            text-align: center;
            padding: 40px 30px;
        }
        
        .auth-body {
            padding: 40px 30px;
        }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            font-weight: 600;
            padding: 12px 25px;
        }
        
        .nav-pills .nav-link.active {
            background: #DA9F5B;
            color: #fff;
        }
        
        .form-control {
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #eee;
            font-size: 16px;
        }
        
        .form-control:focus {
            border-color: #DA9F5B;
            box-shadow: 0 0 0 0.2rem rgba(218,159,91,0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #DA9F5B, #c8935a);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            font-weight: 600;
            color: #fff;
        }
        
        .social-btn {
            transition: all 0.3s ease;
        }
        
        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .brand-link {
            color: #DA9F5B;
            text-decoration: none;
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .brand-link:hover {
            color: #c8935a;
            text-decoration: none;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #666;
            font-size: 1.2rem;
            text-decoration: none;
        }
        
        .back-link:hover {
            color: #DA9F5B;
            text-decoration: none;
        }
    </style>
</head>

<body>
    <a href="index.html" class="back-link">
        <i class="fas fa-arrow-right"></i>
    </a>
    
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" class="brand-link">
                    <h2>Noir Café</h2>
                </a>
                <p class="mb-0 mt-3">مرحباً بك في مقهى نوار</p>
            </div>
            
            <div class="auth-body">
                <!-- Auth Tabs -->
                <ul class="nav nav-pills nav-justified mb-4" id="authTabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="login-tab" data-toggle="pill" href="#login-content">تسجيل الدخول</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="register-tab" data-toggle="pill" href="#register-content">حساب جديد</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Login Tab -->
                    <div class="tab-pane fade show active" id="login-content">
                        <!-- Email/Password Login Form -->
                        <form id="loginForm" onsubmit="signInWithEmail(event)">
                            <div class="form-group">
                                <label for="loginEmail">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="loginEmail" required placeholder="example@gmail.com">
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">كلمة المرور</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="loginPassword" required placeholder="••••••••">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('loginPassword')">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block btn-lg mb-3">
                                <i class="fa fa-sign-in-alt mr-2"></i>
                                تسجيل الدخول
                            </button>
                        </form>

                        <div class="text-center mb-3">
                            <button class="btn btn-link text-primary p-0" onclick="showForgotPassword()">
                                نسيت كلمة المرور؟
                            </button>
                        </div>

                        <div class="text-center mb-3">
                            <small class="text-muted">أو</small>
                        </div>

                        <!-- Google Sign In -->
                        <button class="btn btn-danger btn-block btn-lg mb-3 social-btn" onclick="signInWithGoogle(event)">
                            <i class="fab fa-google mr-2"></i>
                            تسجيل الدخول بواسطة Google
                        </button>
                    </div>

                    <!-- Register Tab -->
                    <div class="tab-pane fade" id="register-content">
                        <!-- Registration Form -->
                        <form id="registerForm" onsubmit="registerWithEmail(event)">
                            <div class="form-group">
                                <label for="registerName">الاسم الكامل</label>
                                <input type="text" class="form-control" id="registerName" required placeholder="أحمد محمد">
                            </div>
                            <div class="form-group">
                                <label for="registerEmail">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="registerEmail" required placeholder="example@gmail.com">
                            </div>
                            <div class="form-group">
                                <label for="registerPassword">كلمة المرور</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="registerPassword" required placeholder="••••••••" minlength="6">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('registerPassword')">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <small class="text-muted">يجب أن تكون 6 أحرف على الأقل</small>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">تأكيد كلمة المرور</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirmPassword" required placeholder="••••••••">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">
                                            <i class="fa fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    أوافق على <a href="#" class="text-primary">شروط الاستخدام</a> و <a href="#" class="text-primary">سياسة الخصوصية</a>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-success btn-block btn-lg mb-3">
                                <i class="fa fa-user-plus mr-2"></i>
                                إنشاء حساب جديد
                            </button>
                        </form>

                        <div class="text-center mb-3">
                            <small class="text-muted">أو</small>
                        </div>

                        <!-- Google Sign Up -->
                        <button class="btn btn-danger btn-block btn-lg social-btn" onclick="signInWithGoogle(event)">
                            <i class="fab fa-google mr-2"></i>
                            إنشاء حساب بواسطة Google
                        </button>
                    </div>
                </div>

                <!-- Forgot Password Section (Hidden by default) -->
                <div id="forgotPasswordSection" style="display: none;">
                    <div class="text-center mb-4">
                        <h4><i class="fa fa-key text-warning"></i> إعادة تعيين كلمة المرور</h4>
                        <p class="text-muted">أدخل بريدك الإلكتروني لإرسال رابط إعادة التعيين</p>
                    </div>
                    
                    <form id="forgotPasswordForm" onsubmit="sendPasswordReset(event)">
                        <div class="form-group">
                            <label for="resetEmail">البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="resetEmail" required placeholder="example@gmail.com">
                        </div>
                        <button type="submit" class="btn btn-warning btn-block btn-lg mb-3">
                            <i class="fa fa-paper-plane mr-2"></i>
                            إرسال رابط إعادة التعيين
                        </button>
                    </form>
                    
                    <div class="text-center">
                        <button class="btn btn-link text-primary" onclick="backToLogin()">
                            <i class="fa fa-arrow-right mr-2"></i>
                            العودة لتسجيل الدخول
                        </button>
                    </div>
                </div>

                <!-- Information Section -->
                <div class="text-center mt-4" id="infoSection">
                    <div class="text-muted small">
                        <p class="mb-2"><i class="fa fa-shield-alt text-success"></i> تسجيل الدخول آمن ومحمي</p>
                        <p class="mb-2"><i class="fa fa-user-check text-primary"></i> لن نقوم بنشر أي شيء على حسابك</p>
                        <p class="mb-0"><i class="fa fa-lock text-warning"></i> نحن نحترم خصوصيتك تماماً</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBlGaghNVTvLXiykCaIrTszEVuHd5TG4U",
            authDomain: "coffeenoir-1fe6b.firebaseapp.com",
            projectId: "coffeenoir-1fe6b",
            storageBucket: "coffeenoir-1fe6b.firebasestorage.app",
            messagingSenderId: "846057487909",
            appId: "1:846057487909:web:37490e1ef5d53ebc4989cc",
            measurementId: "G-4XB0L1T0XM"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Initialize Google Auth Provider
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        googleProvider.addScope('email');
        googleProvider.addScope('profile');
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        console.log('✅ Firebase initialized for login page');
    </script>

    <!-- Authentication Functions -->
    <script>
        // Toggle password visibility
        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = passwordInput.nextElementSibling.querySelector('button i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.className = 'fa fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleButton.className = 'fa fa-eye';
            }
        }

        // Show Alert Function
        function showAlert(message, type = 'info') {
            const alertTypes = {
                success: { class: 'alert-success', icon: 'fa-check-circle' },
                error: { class: 'alert-danger', icon: 'fa-exclamation-circle' },
                warning: { class: 'alert-warning', icon: 'fa-exclamation-triangle' },
                info: { class: 'alert-info', icon: 'fa-info-circle' }
            };
            
            const alertConfig = alertTypes[type] || alertTypes.info;
            
            const alertHtml = `
                <div class="alert ${alertConfig.class} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 10000; min-width: 300px; max-width: 500px;">
                    <i class="fas ${alertConfig.icon} mr-2"></i>
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            // Remove existing alerts
            document.querySelectorAll('.alert.position-fixed').forEach(alert => alert.remove());
            
            // Add new alert
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert.position-fixed');
                if (alert) alert.remove();
            }, 5000);
        }

        // Sign in with Email and Password
        async function signInWithEmail(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                console.log('🔐 Attempting email sign in for:', email);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>جاري تسجيل الدخول...';
                
                const result = await auth.signInWithEmailAndPassword(email, password);
                console.log('✅ Email sign in successful:', result.user.email);
                
                showAlert('تم تسجيل الدخول بنجاح!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Email sign in error:', error);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fa fa-sign-in-alt mr-2"></i>تسجيل الدخول';
                
                let errorMessage = 'حدث خطأ في تسجيل الدخول';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'البريد الإلكتروني غير مسجل. يرجى إنشاء حساب جديد.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'كلمة المرور غير صحيحة';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صحيح';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'تم تعطيل هذا الحساب';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'تم تجاوز عدد المحاولات المسموح. حاول لاحقاً.';
                        break;
                }
                
                showAlert(errorMessage, 'error');
            }
        }

        // Register with Email and Password
        async function registerWithEmail(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (password !== confirmPassword) {
                    showAlert('كلمات المرور غير متطابقة', 'error');
                    return;
                }
                
                console.log('🔐 Attempting email registration for:', email);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>جاري إنشاء الحساب...';
                
                const result = await auth.createUserWithEmailAndPassword(email, password);
                const user = result.user;
                
                await user.updateProfile({
                    displayName: name
                });
                
                console.log('✅ Email registration successful:', user.email);
                
                await user.sendEmailVerification();
                
                showAlert('تم إنشاء الحساب بنجاح! تم إرسال رابط التفعيل لبريدك الإلكتروني.', 'success');
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1500);
                
            } catch (error) {
                console.error('❌ Email registration error:', error);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fa fa-user-plus mr-2"></i>إنشاء حساب جديد';
                
                let errorMessage = 'حدث خطأ في إنشاء الحساب';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'البريد الإلكتروني مستخدم مسبقاً. جرب تسجيل الدخول بدلاً من ذلك.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صحيح';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'كلمة المرور ضعيفة. يجب أن تكون 6 أحرف على الأقل';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'تسجيل الحسابات الجديدة معطل حالياً';
                        break;
                }
                
                showAlert(errorMessage, 'error');
            }
        }

        // Sign in with Google
        async function signInWithGoogle(event) {
            try {
                console.log('🚀 Attempting Google sign in...');
                
                const loginButton = event?.target;
                if (loginButton) {
                    loginButton.disabled = true;
                    loginButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>جاري تسجيل الدخول...';
                }
                
                const result = await auth.signInWithPopup(googleProvider);
                console.log('✅ Google sign in successful:', result.user.displayName);
                
                showAlert('تم تسجيل الدخول بنجاح!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Google sign in error:', error);
                
                const loginButton = event?.target;
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fab fa-google mr-2"></i>تسجيل الدخول بواسطة Google';
                }
                
                if (error.code === 'auth/popup-closed-by-user') {
                    return;
                } else if (error.code === 'auth/cancelled-popup-request') {
                    return;
                } else if (error.code === 'auth/popup-blocked') {
                    showAlert('تم حظر النافذة المنبثقة. يرجى السماح للنوافذ المنبثقة وإعادة المحاولة.', 'warning');
                } else {
                    showAlert('حدث خطأ في تسجيل الدخول. يرجى المحاولة مرة أخرى.', 'error');
                }
            }
        }

        // Send Password Reset Email
        async function sendPasswordReset(event) {
            event.preventDefault();
            
            try {
                const email = document.getElementById('resetEmail').value;
                
                console.log('🔑 Sending password reset for:', email);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>جاري الإرسال...';
                
                await auth.sendPasswordResetEmail(email);
                
                console.log('✅ Password reset email sent');
                
                showAlert('تم إرسال رابط إعادة تعيين كلمة المرور لبريدك الإلكتروني', 'success');
                
                backToLogin();
                
            } catch (error) {
                console.error('❌ Password reset error:', error);
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>إرسال رابط إعادة التعيين';
                
                let errorMessage = 'حدث خطأ في إرسال رابط إعادة التعيين';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'البريد الإلكتروني غير مسجل';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'البريد الإلكتروني غير صحيح';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'تم تجاوز عدد المحاولات المسموح. حاول لاحقاً.';
                        break;
                }
                
                showAlert(errorMessage, 'error');
            }
        }

        // Show Forgot Password Section
        function showForgotPassword() {
            document.getElementById('authTabs').style.display = 'none';
            document.querySelector('.tab-content').style.display = 'none';
            document.getElementById('infoSection').style.display = 'none';
            document.getElementById('forgotPasswordSection').style.display = 'block';
        }

        // Back to Login
        function backToLogin() {
            document.getElementById('authTabs').style.display = 'flex';
            document.querySelector('.tab-content').style.display = 'block';
            document.getElementById('infoSection').style.display = 'block';
            document.getElementById('forgotPasswordSection').style.display = 'none';
            
            // Reset form
            document.getElementById('forgotPasswordForm').reset();
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('👤 User already logged in, redirecting to profile...');
                window.location.href = 'profile.html';
            }
        });
    </script>
</body>

</html>
